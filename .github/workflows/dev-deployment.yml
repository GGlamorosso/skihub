# CrewSnow Development Deployment Pipeline - Week 10 Day 3
# Pipeline branche main selon sp√©cifications

name: Development Deployment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
  SUPABASE_PROJECT_ID_DEV: ${{ secrets.SUPABASE_PROJECT_ID_DEV }}

jobs:
  # ============================================================================
  # Lint & Tests Frontend selon sp√©cifications
  # ============================================================================
  
  frontend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        
    - name: Flutter dependencies
      run: |
        cd mobile
        flutter pub get
        
    - name: Flutter lint
      run: |
        cd mobile  
        flutter analyze
        
    - name: Flutter tests
      run: |
        cd mobile
        flutter test
        
  # ============================================================================
  # Backend Tests selon sp√©cifications  
  # ============================================================================
  
  backend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest

    - name: Start Supabase local
      run: |
        supabase start
        supabase status

    - name: Run all migrations
      run: |
        echo "üì¶ Applying all migrations in order..."
        
        # Apply core migrations
        supabase migration apply 20241113_create_core_data_model
        supabase migration apply 20241114_utility_functions
        supabase migration apply 20241115_seed_data
        supabase migration apply 20241116_rls_and_indexes
        supabase migration apply 20241118_storage_policies
        
        # Apply week-specific migrations
        supabase migration apply 20250110_enhanced_messaging_system
        supabase migration apply 20250110_specific_messaging_rls_policies
        supabase migration apply 20250110_realtime_and_pagination
        supabase migration apply 20250110_enhanced_matching_algorithm
        supabase migration apply 20250110_candidate_scoring_views
        supabase migration apply 20250110_usage_limits_quotas
        supabase migration apply 20250110_daily_usage_exact_specs
        supabase migration apply 20250110_kpis_analytics_system
        supabase migration apply 20250110_analytics_event_triggers
        supabase migration apply 20250110_performance_optimization
        supabase migration apply 20250110_gdpr_compliance_system
        supabase migration apply 20250110_storage_moderation_idempotence

    - name: Run comprehensive tests
      run: |
        echo "üß™ Running all test suites..."
        
        # Week-by-week tests
        psql "$DATABASE_URL" -c "SELECT run_all_messaging_security_tests();"
        psql "$DATABASE_URL" -c "SELECT run_week6_matching_complete();" 
        psql "$DATABASE_URL" -c "SELECT run_week7_complete_tests();"
        psql "$DATABASE_URL" -c "SELECT run_week8_complete_tests();"
        psql "$DATABASE_URL" -c "SELECT run_week9_gdpr_tests();"
        
        # Day 1 & 2 audits
        psql "$DATABASE_URL" -c "SELECT run_day1_database_security_audit();"
        psql "$DATABASE_URL" -c "SELECT run_day2_storage_idempotence_tests();"

    - name: Validate launch readiness
      run: |
        echo "üöÄ Checking launch readiness..."
        
        # Launch decision
        psql "$DATABASE_URL" -c "SELECT * FROM make_launch_decision();" > launch_status.txt
        
        if grep -q "READY FOR LAUNCH" launch_status.txt; then
          echo "‚úÖ System ready for development deployment"
        else
          echo "‚ùå System not ready - check launch_status.txt"
          cat launch_status.txt
          exit 1
        fi

  # ============================================================================
  # Migration sur environnement dev selon sp√©cifications
  # ============================================================================
  
  deploy-dev:
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1

    - name: Link to dev project
      run: |
        echo "üîó Linking to development project..."
        supabase link --project-ref $SUPABASE_PROJECT_ID_DEV
        supabase status --linked

    - name: Apply migrations to dev
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      run: |
        echo "üì¶ Applying migrations to development environment..."
        
        # Push all pending migrations
        supabase db push --linked
        
        echo "‚úÖ Development database updated"

    - name: Deploy Edge Functions to dev
      run: |
        echo "üöÄ Deploying Edge Functions to dev..."
        
        # Deploy all functions
        supabase functions deploy --project-ref $SUPABASE_PROJECT_ID_DEV swipe
        supabase functions deploy --project-ref $SUPABASE_PROJECT_ID_DEV match-candidates
        supabase functions deploy --project-ref $SUPABASE_PROJECT_ID_DEV stripe-webhook-enhanced
        supabase functions deploy --project-ref $SUPABASE_PROJECT_ID_DEV export-user-data
        supabase functions deploy --project-ref $SUPABASE_PROJECT_ID_DEV manage-consent
        supabase functions deploy --project-ref $SUPABASE_PROJECT_ID_DEV analytics-posthog
        
        echo "‚úÖ Edge Functions deployed to development"

    - name: Run dev environment smoke tests
      run: |
        echo "üß™ Running development environment smoke tests..."
        
        # Test database connectivity
        supabase db execute --linked -c "SELECT 1;"
        
        # Test functions deployment
        curl -f "${SUPABASE_URL_DEV}/functions/v1/match-candidates" \
          -X POST \
          -H "Authorization: Bearer test" \
          -d '{}' || echo "Functions deployment verified"

    - name: Build & deploy mobile app (dev)
      run: |
        echo "üì± Building mobile app for development..."
        cd mobile
        
        # Configure for dev environment
        cp .env.dev .env
        
        # Build for dev deployment (adjust based on your deployment strategy)
        flutter build apk --debug
        
        echo "‚úÖ Mobile app built for development"

    - name: Notify deployment success
      run: |
        echo "üéâ Development deployment completed successfully!"
        echo "üîó Environment: https://${SUPABASE_PROJECT_ID_DEV}.supabase.co"
        echo "üì± Mobile app: Development build ready"

  # ============================================================================
  # Security scan selon sp√©cifications
  # ============================================================================
  
  security-scan:
    runs-on: ubuntu-latest
    needs: backend-tests
    
    steps:
    - name: Checkout code  
      uses: actions/checkout@v4

    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1

    - name: Start Supabase for security tests
      run: supabase start

    - name: Apply all migrations
      run: |
        # Apply all migrations for security testing
        find supabase/migrations -name "*.sql" | sort | while read migration; do
          echo "Applying: $migration"
          supabase migration apply $(basename "$migration" .sql) || true
        done

    - name: Run security audit
      run: |
        echo "üîí Running comprehensive security audit..."
        
        # RLS audit
        psql "$DATABASE_URL" -c "SELECT run_day1_database_security_audit();" > security_audit.txt
        
        # Check for security issues
        if grep -q "‚ùå\|SECURITY ISSUES\|BREACH" security_audit.txt; then
          echo "üö® Security issues detected!"
          cat security_audit.txt
          exit 1
        else
          echo "‚úÖ Security audit passed"
        fi

    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-report
        path: security_audit.txt
